<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WilsChat - Estilo WhatsApp</title>
<style>
body{font-family:Arial,sans-serif;background:#e5ddd5;margin:0;padding:0;color:#333;}
header{background:#075e54;color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
img{max-width:100%;border-radius:6px;margin-top:6px;}
audio{margin-top:6px;width:100%;}

#chatMenuWindow{
    position:fixed; top:70px; left:10px; width:240px; max-height:60vh;
    background:#fff; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.3);
    padding:10px; display:none; z-index:100; overflow-y:auto; font-family:Arial,sans-serif;
}
#chatMenuWindow::-webkit-scrollbar {width:8px;}
#chatMenuWindow::-webkit-scrollbar-track {background:#f0f0f0; border-radius:4px;}
#chatMenuWindow::-webkit-scrollbar-thumb {background-color:#128c7e; border-radius:4px; border:2px solid #f0f0f0;}
#chatMenuWindow {scrollbar-width: thin; scrollbar-color:#128c7e #f0f0f0;}
#usersList > strong {display:block;margin:10px 0 6px 0; font-size:14px; color:#075e54; border-bottom:1px solid #ccc; padding-bottom:4px;}

.status {
    display:flex; align-items:center; padding:6px 10px; border-radius:8px; cursor:pointer;
    transition:background 0.2s, transform 0.1s;
}
.status:hover {background:#e0f2f1; transform:translateX(2px);}
.online {background:#e6f7ef;}
.offline {background:#f5f5f5;}
.status span.name {font-weight:bold; color:#333; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px;}
.status .avatar {
    width:32px; height:32px; border-radius:50%; color:#fff; display:flex; align-items:center; justify-content:center;
    font-weight:bold; font-size:14px; margin-right:8px; flex-shrink:0; text-transform:uppercase;
}

#login,#chat{display:flex;flex-direction:column;margin:10px auto;background:#fff;border-radius:10px;padding:15px;box-shadow:0 2px 6px rgba(0,0,0,0.1);width:95%;max-width:600px;}
#login h3 {font-size:1.5em; margin-bottom:12px;}
#username {font-size:1.1em; padding:10px;}
#enterBtn {font-size:1.2em; padding:12px 20px;}
#chat{display:none;}
#messages{flex:1;padding:12px;overflow-y:auto;margin-bottom:70px;border-radius:8px;background:#e5ddd5;display:flex;flex-direction:column;}
.msg{margin-bottom:6px;padding:10px 14px;border-radius:20px;max-width:75%;word-wrap:break-word;display:inline-block;}
.me{background:#dcf8c6;align-self:flex-end;}
.other{background:#fff;align-self:flex-start;}
.system{text-align:center;font-style:italic;color:#666;background:none;}
.meta{font-size:.7em;color:#555;margin-top:4px;text-align:right;}
.date-sep{text-align:center;font-size:.75em;color:#999;margin:10px 0;font-weight:bold;}

#privateChatFull{position:fixed;top:0;left:0;width:100%;height:100%;background:#e5ddd5;z-index:200;display:none;flex-direction:column;padding:30px;box-sizing:border-box;}
#privateHeader{background:#075e54;color:#fff;padding:12px 15px;font-weight:bold;display:flex;justify-content:space-between;align-items:center;border-radius:6px;margin-bottom:15px;}
#privateMessages{flex:1;overflow-y:auto;padding:15px;background:#d2f7d1;border-radius:8px;margin-bottom:70px;display:flex;flex-direction:column;}
#privateMessages .msg{border-radius:20px;max-width:75%;padding:10px 14px;word-wrap:break-word;margin-bottom:6px;}
#privateMessages .me{background:#dcf8c6;align-self:flex-end;}
#privateMessages .other{background:#fff;align-self:flex-start;}
#privateMessages .meta{font-size:.7em;color:#555;margin-top:4px;text-align:right;}
.date-sep-private{text-align:center;font-size:.75em;color:#999;margin:10px 0;font-weight:bold;}

.controls, #privateControls {
  display:flex;align-items:center;gap:8px;padding:10px 0;position:sticky;bottom:0;background:#fff;box-shadow:0 -2px 6px rgba(0,0,0,0.1);z-index:50;
}

.controls textarea, #privateControls textarea {
  flex:1;padding:12px 16px;border-radius:24px;border:1px solid #ccc;outline:none;font-size:16px;transition:all 0.2s;background:#f5f5f5;resize:none;min-height:44px;max-height:120px;overflow-y:auto;
}

.controls textarea:focus, #privateControls textarea:focus{border-color:#128c7e;box-shadow:0 0 8px rgba(18,140,126,0.3);background:#fff;}
.controls button, #privateControls button{padding:12px 18px;border-radius:24px;background:#128c7e;color:#fff;font-weight:bold;border:none;cursor:pointer;transition:all 0.2s;}
.controls button:hover, #privateControls button:hover{background:#0f7a66;}
@media(max-width:500px){#chatMenuWindow{width:80%;top:60px;left:10%;padding:10px;}#login,#chat{width:95%;padding:12px;margin:10px;} .controls textarea,#privateControls textarea{min-width:80px;}#privateChatFull{padding:15px;}#privateHeader{font-size:14px;padding:10px;}}
</style>
</head>
<body>

<header>
  <strong>WilsChat</strong>
  <!-- BotÃ³n menÃº con texto "Chatear" dentro antes de las â˜° -->
  <div id="chatMenuBtn" style="display:none; cursor:pointer; font-weight:bold;">Chatear â˜°</div>
</header>

<div id="chatMenuWindow"><div id="usersList"></div></div>

<div id="login">
  <h3>Ingresa tu nombre</h3>
  <input id="username" placeholder="Tu nombre">
  <button id="enterBtn">Entrar</button>
</div>

<div id="chat">
  <div id="messages"></div>
  <div class="controls">
    <textarea id="text" placeholder="Escribe un mensaje"></textarea>
    <input type="file" id="photoInput" accept="image/*" hidden>
    <button onclick="photoInput.click()">ðŸ“·</button>
    <button id="recordBtn">ðŸŽ¤</button>
    <button id="sendBtn">Enviar</button>
  </div>
</div>

<div id="privateChatFull">
  <div id="privateHeader">
    <span id="privateUserName"></span>
    <button id="closePrivateBtn">âœ– Salir</button>
  </div>
  <div id="privateMessages"></div>
  <div id="privateControls">
    <textarea id="privateText" placeholder="Escribe un mensaje"></textarea>
    <button id="privateSendBtn">Enviar</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
var firebaseConfig={apiKey:"AIzaSyAEkdn1nVDbrJEQY13JrE-peN1JkXrOy24",authDomain:"wilschat-1b27d.firebaseapp.com",databaseURL:"https://wilschat-1b27d-default-rtdb.firebaseio.com",projectId:"wilschat-1b27d",storageBucket:"wilschat-1b27d.appspot.com",messagingSenderId:"550632985900",appId:"1:550632985900:web:c886e89b4330560b6ac889"};
firebase.initializeApp(firebaseConfig);

var db=firebase.database(), storage=firebase.storage();
var user="", presenceKey=null, currentRef=null, privateWith=null;

const avatarColors = ["#128c7e","#075e54","#34b7f1","#f39c12","#e74c3c","#8e44ad","#2ecc71","#d35400","#3498db","#1abc9c"];
function getAvatarColor(name){
    let hash=0; for(let i=0;i<name.length;i++){hash=name.charCodeAt(i)+((hash<<5)-hash);}
    let index=Math.abs(hash)%avatarColors.length;
    return avatarColors[index];
}

function chatId(a,b){return [a,b].sort().join("_");}
function formatDate(ts){ let d=new Date(ts); let today=new Date(); let yesterday=new Date(today); yesterday.setDate(today.getDate()-1);
if(d.toDateString()===today.toDateString()) return "Hoy";
if(d.toDateString()===yesterday.toDateString()) return "Ayer";
return d.toLocaleDateString(); }
function time(ts){return new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}

var lastDatePublic=null;
function addMsg(m, container){
  var msgDate=formatDate(m.ts);
  if(container.id==="messages" && lastDatePublic!==msgDate){
    var sep=document.createElement("div"); sep.className="date-sep"; sep.textContent=msgDate;
    container.appendChild(sep); lastDatePublic=msgDate;
  }
  var div=document.createElement("div"); div.className="msg "+(m.user===user?"me":"other");
  if(m.system){div.className+=" system"; div.textContent=m.text+" â€” "+time(m.ts); container.appendChild(div); container.scrollTop=container.scrollHeight; return;}
  div.innerHTML="<strong>"+m.user+":</strong> ";
  if(m.type==="image"){var i=document.createElement("img"); i.src=m.url; div.appendChild(i);}
  else if(m.type==="audio"){var a=document.createElement("audio"); a.controls=true; a.src=m.url; div.appendChild(a);}
  else div.innerHTML+=" "+m.text;
  var meta=document.createElement("div"); meta.className="meta"; meta.textContent=time(m.ts); div.appendChild(meta);
  if(container.id==="messages" && m.user!==user){ div.style.cursor="pointer"; div.onclick=function(){ openPrivateFull(m.user); } }
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

enterBtn.onclick=function(){
  if(!username.value.trim()) return; user=username.value.trim();
  login.style.display="none"; chat.style.display="flex";

  document.getElementById("chatMenuBtn").style.display="block";

  db.ref("users/"+user).set({name:user,lastSeen:Date.now()});
  var ref=db.ref("presence").push({name:user}); presenceKey=ref.key; ref.onDisconnect().remove();
  db.ref("mensajes").push({system:true,text:user+" entrÃ³ al chat",ts:Date.now()});
  listenPublic();

  updateUsers();
}

function listenPublic(){
  if(currentRef) currentRef.off();
  var container=document.getElementById("messages"); container.innerHTML=""; lastDatePublic=null;
  currentRef=db.ref("mensajes").limitToLast(200);
  currentRef.on("child_added", s=>{if(s.val()) addMsg(s.val(), container);});
}

sendBtn.onclick=function(){ let txt=document.getElementById("text"); if(!txt.value.trim()) return;
  db.ref("mensajes").push({user:user,text:txt.value,ts:Date.now()}); txt.value="";
}

photoInput.onchange=function(e){ var f=e.target.files[0]; if(!f) return;
  var r=storage.ref("photos/"+Date.now()+f.name); r.put(f).then(s=>s.ref.getDownloadURL().then(u=>{
  db.ref("mensajes").push({user:user,type:"image",url:u,ts:Date.now()}); }));
}

let rec,chunks=[];
recordBtn.onclick=async function(){
  if(!rec||rec.state==="inactive"){ var st=await navigator.mediaDevices.getUserMedia({audio:true});
    rec=new MediaRecorder(st); chunks=[]; rec.ondataavailable=e=>chunks.push(e.data);
    rec.onstop=()=>{ var b=new Blob(chunks,{type:"audio/webm"}); var r=storage.ref("audios/"+Date.now()+".webm");
      r.put(b).then(s=>s.ref.getDownloadURL().then(u=>{ db.ref("mensajes").push({user:user,type:"audio",url:u,ts:Date.now()}); }));
    };
    rec.start(); this.textContent="â¹ï¸";
  }else{rec.stop(); this.textContent="ðŸŽ¤";}
}

function updateUsers(){
  Promise.all([db.ref("users").once("value"),db.ref("presence").once("value")])
  .then(([u,p])=>{
    var online=[]; p.forEach(c=>online.push(c.val().name));
    var html="<strong>Chat</strong>";

    u.forEach(c=>{ var n=c.key; if(online.includes(n)){
      let initial=n.charAt(0).toUpperCase(); let color=getAvatarColor(n);
      html+=`<div class="status online" onclick="openPrivateFull('${n}')">
                <div class="avatar" style="background-color:${color}">${initial}</div>
                <span class="name">${n}</span>
             </div>`; 
    }});

    html+="<strong>No conectados</strong>";
    u.forEach(c=>{ var n=c.key; if(!online.includes(n)){
      let initial=n.charAt(0).toUpperCase(); let color=getAvatarColor(n);
      html+=`<div class="status offline">
                <div class="avatar" style="background-color:${color}">${initial}</div>
                <span class="name">${n}</span>
             </div>`; 
    }});

    document.getElementById("usersList").innerHTML=html;
    document.getElementById("chatMenuWindow").scrollTop=0;
  });
}

db.ref("presence").on("value",updateUsers);
db.ref("users").on("value",updateUsers);

function openPrivateFull(name){
  if(name===user) return; privateWith=name;
  document.getElementById("privateUserName").textContent=name;
  document.getElementById("privateChatFull").style.display="flex";
  var container=document.getElementById("privateMessages"); container.innerHTML="";
  let lastDatePrivate=null;
  db.ref("mensajes_privados/"+chatId(user,name)).limitToLast(200).on("child_added", s=>{
    if(!s.val()) return; let m=s.val(); let msgDate=formatDate(m.ts);
    if(lastDatePrivate!==msgDate){ let sep=document.createElement("div"); sep.className="date-sep-private"; sep.textContent=msgDate; container.appendChild(sep); lastDatePrivate=msgDate;}
    var div=document.createElement("div"); div.className="msg "+(m.user===user?"me":"other");
    if(m.system){div.className+=" system"; div.textContent=m.text+" â€” "+time(m.ts); container.appendChild(div); container.scrollTop=container.scrollHeight; return;}
    div.innerHTML="<strong>"+m.user+":</strong> ";
    if(m.type==="image"){var i=document.createElement("img"); i.src=m.url; div.appendChild(i);}
    else if(m.type==="audio"){var a=document.createElement("audio"); a.controls=true; a.src=m.url; div.appendChild(a);}
    else div.innerHTML+=" "+m.text;
    container.appendChild(div); container.scrollTop=container.scrollHeight;
  });
}

document.getElementById("privateSendBtn").onclick=function(){
  let txt=document.getElementById("privateText"); if(!txt.value.trim()||!privateWith) return;
  db.ref("mensajes_privados/"+chatId(user,privateWith)).push({user:user,text:txt.value,ts:Date.now()}); txt.value="";
}

document.getElementById("closePrivateBtn").onclick=function(){ document.getElementById("privateChatFull").style.display="none"; privateWith=null; }

chatMenuBtn.onclick=function(){ 
  var w=document.getElementById("chatMenuWindow");
  w.style.display = w.style.display==="block"?"none":"block";
}

window.addEventListener("beforeunload",()=>{ if(user) db.ref("users/"+user+"/lastSeen").set(Date.now()); });
</script>
</body>
</html>
