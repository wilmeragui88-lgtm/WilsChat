<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>WilsChat Pro</title>
<style>
/* Dise√±o Profesional - Est√©tica Moderna */
:root {
    --primary: #075e54;
    --primary-dark: #128c7e;
    --accent: #25d366;
    --bg-chat: #efeae2;
    --white: #ffffff;
    --gray-light: #f0f2f5;
    --text-main: #111b21;
    --text-meta: #667781;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: #d1d7db;
    margin: 0;
    padding: 0;
    color: var(--text-main);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Header Estilo App */
header {
    background: var(--primary);
    color: var(--white);
    padding: 10px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    flex-shrink: 0;
    z-index: 1000;
}

header strong { font-size: 20px; letter-spacing: 0.5px; }

/* Men√∫ de Usuarios */
#chatMenuWindow {
    position: fixed; top: 60px; left: 10px; width: 280px; max-height: 70vh;
    background: var(--white); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    padding: 8px; display: none; z-index: 1100; overflow-y: auto;
}

.status {
    display: flex; align-items: center; padding: 10px; border-radius: 8px; cursor: pointer;
    margin-bottom: 2px; transition: background 0.2s;
}
.status:hover { background: var(--gray-light); }
.status .avatar {
    width: 40px; height: 40px; border-radius: 50%; color: #fff; display: flex; 
    align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; flex-shrink: 0;
}

/* Login Profesional */
#login {
    display: flex; flex-direction: column; margin: auto; background: var(--white);
    border-radius: 16px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    width: 90%; max-width: 400px; text-align: center;
}
#login h3 { margin-top: 0; color: var(--primary); }
#username {
    padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;
    margin-bottom: 20px; outline: none;
}
#username:focus { border-color: var(--primary); }
#enterBtn {
    background: var(--primary); color: white; border: none; padding: 14px;
    border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer;
}

/* Contenedor de Chat */
#chat { 
    display: none; flex-direction: column; flex: 1; overflow: hidden; 
    width: 100%; max-width: 800px; margin: 0 auto; background: var(--bg-chat);
}

#messages, #privateMessages {
    flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column;
    background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
}

/* Burbujas de Mensaje */
.msg {
    margin-bottom: 8px; padding: 8px 12px; border-radius: 8px; max-width: 85%;
    position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); font-size: 14.5px;
    line-height: 1.4;
}
.me { background: #d9fdd3; align-self: flex-end; border-top-right-radius: 0; }
.other { background: var(--white); align-self: flex-start; border-top-left-radius: 0; }

.meta { font-size: 11px; color: var(--text-meta); margin-top: 4px; display: flex; justify-content: flex-end; align-items: center; gap: 3px; }

/* Barras de Control */
.controls, #privateControls {
    background: var(--gray-light); padding: 10px 16px; display: flex; 
    align-items: center; gap: 10px; flex-shrink: 0;
}
.controls textarea, #privateControls textarea {
    flex: 1; background: var(--white); border: none; padding: 10px 16px;
    border-radius: 20px; font-size: 15px; max-height: 100px; outline: none;
}

/* Botones Circulares */
.btn-round {
    width: 40px; height: 40px; border-radius: 50%; border: none;
    background: var(--primary); color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center; font-size: 18px;
}

/* Chat Privado */
#privateChatFull {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg-chat); z-index: 2000; display: none; flex-direction: column;
}
#privateHeader {
    background: var(--primary); color: white; padding: 10px 16px;
    display: flex; align-items: center; gap: 15px; flex-shrink: 0;
}

.date-sep {
    align-self: center; background: rgba(255,255,255,0.8); padding: 5px 12px;
    border-radius: 8px; font-size: 12px; color: var(--text-meta); margin: 10px 0;
    text-transform: uppercase; font-weight: bold;
}

@media(max-width: 600px) {
    #chat { max-width: 100%; }
    .msg { max-width: 90%; }
}
</style>
</head>
<body>

<header>
  <strong>WilsChat Pro</strong>
  <div id="chatMenuBtn" style="display:none; cursor:pointer; position:relative;">
    <span style="font-size:24px;">‚ãÆ</span>
    <div id="menuBadge"></div>
  </div>
</header>

<div id="chatMenuWindow"><div id="usersList"></div></div>

<div id="login">
  <h3>Bienvenido</h3>
  <input id="username" placeholder="Introduce tu nombre" autocomplete="off">
  <button id="enterBtn">Comenzar a chatear</button>
</div>

<div id="chat">
  <div id="messages"></div>
  <div class="controls">
    <button class="btn-round" onclick="photoInput.click()" style="background:#667781">üì∑</button>
    <input type="file" id="photoInput" accept="image/*" hidden>
    <textarea id="text" placeholder="Mensaje" rows="1"></textarea>
    <button id="recordBtn" class="btn-round" style="background:#667781">üé§</button>
    <button id="sendBtn" class="btn-round">‚û§</button>
  </div>
</div>

<div id="privateChatFull">
  <div id="privateHeader">
    <button id="closePrivateBtn" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">‚Üê</button>
    <div style="flex:1">
        <div id="privateUserName" style="font-weight:bold; font-size:16px;"></div>
        <div id="typingStatus" style="font-size:12px; color:#dcf8c6; height:14px;"></div>
    </div>
  </div>
  <div id="privateMessages"></div>
  <div id="privateControls">
    <textarea id="privateText" placeholder="Mensaje" rows="1"></textarea>
    <button id="privateSendBtn" class="btn-round">‚û§</button>
  </div>
</div>

<audio id="sndSend" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" preload="auto"></audio>
<audio id="sndReceive" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
// Configuraci√≥n y Variables de Estado (Manteniendo tu c√≥digo original)
var firebaseConfig={apiKey:"AIzaSyAEkdn1nVDbrJEQY13JrE-peN1JkXrOy24",authDomain:"wilschat-1b27d.firebaseapp.com",databaseURL:"https://wilschat-1b27d-default-rtdb.firebaseio.com",projectId:"wilschat-1b27d",storageBucket:"wilschat-1b27d.appspot.com",messagingSenderId:"550632985900",appId:"1:550632985900:web:c886e89b4330560b6ac889"};
firebase.initializeApp(firebaseConfig);

var db=firebase.database(), storage=firebase.storage();
var user="", presenceKey=null, currentRef=null, privateWith=null, typingTimeout;
var unreadCounts = {}; 

// Desbloqueo de sonido
document.body.addEventListener("click", ()=>{
  new (window.AudioContext || window.webkitAudioContext)();
},{once:true});

function playSend(){ let a=document.getElementById("sndSend"); a.currentTime=0; a.play().catch(()=>{}); }
function playReceive(){ let a=document.getElementById("sndReceive"); a.currentTime=0; a.play().catch(()=>{}); }

const avatarColors = ["#128c7e","#075e54","#34b7f1","#f39c12","#e74c3c","#8e44ad","#2ecc71","#d35400","#3498db","#1abc9c"];
function getAvatarColor(name){
    let hash=0; for(let i=0;i<name.length;i++){hash=name.charCodeAt(i)+((hash<<5)-hash);}
    let index=Math.abs(hash)%avatarColors.length; return avatarColors[index];
}

function chatId(a,b){return [a,b].sort().join("_");}
function formatDate(ts){ let d=new Date(ts); let today=new Date(); if(d.toDateString()===today.toDateString()) return "Hoy"; return d.toLocaleDateString(); }
function time(ts){return new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}

var lastDatePublic=null;
function addMsg(m, container){
  if(m.user && m.user !== user) playReceive();

  var msgDate=formatDate(m.ts);
  if(container.id==="messages" && lastDatePublic!==msgDate){
    var sep=document.createElement("div"); sep.className="date-sep"; sep.textContent=msgDate;
    container.appendChild(sep); lastDatePublic=msgDate;
  }
  var div=document.createElement("div"); div.className="msg "+(m.user===user?"me":"other");
  
  if(m.system){
      div.className="system"; div.style.alignSelf="center"; div.style.fontSize="11px";
      div.textContent=m.text+" ‚Ä¢ "+time(m.ts); container.appendChild(div); 
      container.scrollTop=container.scrollHeight; return;
  }

  let content = `<strong>${m.user}</strong><br>`;
  if(m.type==="image") content += `<img src="${m.url}">`;
  else if(m.type==="audio") content += `<audio controls src="${m.url}"></audio>`;
  else content += m.text;

  let statusStr = "";
  if (m.user === user && container.id === "privateMessages") {
      statusStr = m.leido ? " <span style='color:#34b7f1'>‚úî‚úî</span>" : " <span style='color:var(--text-meta)'>‚úî</span>";
  }
  
  div.innerHTML = content + `<div class="meta">${time(m.ts)}${statusStr}</div>`;
  
  if(container.id==="messages" && m.user!==user){ 
      div.style.cursor="pointer"; 
      div.onclick=() => openPrivateFull(m.user); 
  }
  
  container.appendChild(div); 
  container.scrollTop = container.scrollHeight;
}

enterBtn.onclick=function(){
  if(!username.value.trim()) return; user=username.value.trim();
  login.style.display="none"; chat.style.display="flex";
  document.getElementById("chatMenuBtn").style.display="block";
  db.ref("users/"+user).set({name:user,lastSeen:Date.now()});
  var ref=db.ref("presence").push({name:user}); presenceKey=ref.key; ref.onDisconnect().remove();
  db.ref("mensajes").push({system:true,text:user+" entr√≥",ts:Date.now()});
  listenPublic(); listenForPrivateNotif(); updateUsers();
}

function listenPublic(){
  if(currentRef) currentRef.off();
  var container=document.getElementById("messages"); container.innerHTML=""; lastDatePublic=null;
  currentRef=db.ref("mensajes").limitToLast(50);
  currentRef.on("child_added", s=>{if(s.val()) addMsg(s.val(), container);});
}

function listenForPrivateNotif(){
    db.ref("mensajes_privados").on("child_added", (snap) => {
        if(snap.key.includes(user)){
            snap.ref.limitToLast(1).on("child_added", (mSnap) => {
                let m = mSnap.val();
                if(m.user !== user && privateWith !== m.user){
                    unreadCounts[m.user] = (unreadCounts[m.user] || 0) + 1;
                    document.getElementById("menuBadge").style.display = "block";
                    updateUsers(); playReceive(); 
                }
            });
        }
    });
}

sendBtn.onclick=function(){ 
  let txt=document.getElementById("text"); if(!txt.value.trim()) return;
  db.ref("mensajes").push({user:user,text:txt.value,ts:Date.now()}); txt.value=""; playSend();
}

// Enter Key Support
document.getElementById("text").onkeydown = e => { if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } };
document.getElementById("privateText").onkeydown = e => { if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); privateSendBtn.click(); } };

function updateUsers(){
  Promise.all([db.ref("users").once("value"),db.ref("presence").once("value")])
  .then(([u,p])=>{
    var online=[]; p.forEach(c=>online.push(c.val().name));
    var html="<strong style='padding:10px; display:block; color:var(--primary)'>CONTACTOS</strong>";
    u.forEach(c=>{ var n=c.key; if(online.includes(n) && n !== user){
      let color=getAvatarColor(n);
      let count = unreadCounts[n] ? `<span class="badge">${unreadCounts[n]}</span>` : "";
      html+=`<div class="status" onclick="openPrivateFull('${n}')">
                <div class="avatar" style="background-color:${color}">${n.charAt(0)}</div>
                <div style="flex:1"><span class="name">${n}</span></div> ${count}
             </div>`; 
    }});
    document.getElementById("usersList").innerHTML=html;
  });
}

function openPrivateFull(name){
  if(name===user) return; 
  privateWith=name;
  unreadCounts[name] = 0; 
  if(Object.values(unreadCounts).every(v => v === 0)) document.getElementById("menuBadge").style.display="none";

  document.getElementById("privateUserName").textContent=name;
  document.getElementById("privateChatFull").style.display="flex";
  var container=document.getElementById("privateMessages"); container.innerHTML="";
  
  db.ref("mensajes_privados/" + chatId(user, name)).orderByChild("user").equalTo(name).once("value", snap => {
    snap.forEach(c => { if (c.val().leido === false) c.ref.update({ leido: true }); });
  });

  db.ref("mensajes_privados/"+chatId(user,name)).limitToLast(50).on("child_added", s=>{
    if(s.val()) addMsg(s.val(), container);
  });
  
  db.ref("typing/" + user + "/" + name).on("value", (snap) => {
    document.getElementById("typingStatus").textContent = snap.exists() ? "escribiendo..." : "";
  });
  updateUsers();
}

document.getElementById("privateText").oninput = () => {
  if (!privateWith) return;
  db.ref("typing/" + privateWith + "/" + user).set(true);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => { if (privateWith) db.ref("typing/" + privateWith + "/" + user).remove(); }, 2000);
};

document.getElementById("privateSendBtn").onclick=function(){
  let txt=document.getElementById("privateText"); if(!txt.value.trim()||!privateWith) return;
  db.ref("mensajes_privados/"+chatId(user,privateWith)).push({user:user,text:txt.value,ts:Date.now(),leido: false}); 
  db.ref("typing/" + privateWith + "/" + user).remove();
  txt.value=""; playSend(); 
}

document.getElementById("closePrivateBtn").onclick=function(){ 
  if(privateWith) {
      db.ref("typing/" + privateWith + "/" + user).remove();
      db.ref("typing/" + user + "/" + privateWith).off();
      db.ref("mensajes_privados/"+chatId(user,privateWith)).off();
  }
  document.getElementById("privateChatFull").style.display="none"; 
  privateWith=null; 
}

chatMenuBtn.onclick=() => { 
  var w=document.getElementById("chatMenuWindow");
  w.style.display = w.style.display==="block"?"none":"block";
}

photoInput.onchange=e=>{ 
  var f=e.target.files[0]; if(!f) return;
  var r=storage.ref("photos/"+Date.now()+f.name); 
  r.put(f).then(s=>s.ref.getDownloadURL().then(u=>{
    db.ref("mensajes").push({user:user,type:"image",url:u,ts:Date.now()}); playSend(); 
  }));
}

let rec,chunks=[];
recordBtn.onclick=async function(){
  if(!rec||rec.state==="inactive"){ 
    var st=await navigator.mediaDevices.getUserMedia({audio:true});
    rec=new MediaRecorder(st); chunks=[]; rec.ondataavailable=e=>chunks.push(e.data);
    rec.onstop=()=>{ 
        var b=new Blob(chunks,{type:"audio/webm"}); 
        var r=storage.ref("audios/"+Date.now()+".webm");
        r.put(b).then(s=>s.ref.getDownloadURL().then(u=>{ 
            db.ref("mensajes").push({user:user,type:"audio",url:u,ts:Date.now()}); playSend(); 
        }));
    };
    rec.start(); this.style.background="#e74c3c";
  }else{ rec.stop(); this.style.background="#667781"; }
}

window.onbeforeunload=() => { if(user) db.ref("users/"+user+"/lastSeen").set(Date.now()); };
</script>
</body>
</html>
