<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WilsChat</title>
<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:0;}
header{background:#4CAF50;color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
#chatMenuBtn{cursor:pointer;padding:6px 12px;background:#388E3C;border-radius:6px;color:#fff;font-weight:bold;}
#chatMenuWindow{position:fixed;top:70px;left:10px;width:240px;max-height:400px;overflow:auto;background:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);display:none;padding:12px;z-index:100;}
.status{margin-right:5px;cursor:pointer;display:block;padding:4px 2px;}
.online{color:#aaffaa;}
.offline{color:#ddd;}
#login,#chat{display:flex;flex-direction:column;height:calc(100vh - 70px);margin:10px 15px;background:#fff;border-radius:10px;padding:15px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
#messages{flex:1;border:1px solid #ddd;padding:12px;overflow-y:auto;margin-bottom:12px;border-radius:8px;background:#fafafa;}
.msg{margin-bottom:10px;padding:8px 12px;border-radius:8px;background:#eee;}
.me{background:#c8f7c5;text-align:right;}
.system{text-align:center;font-style:italic;color:#666;background:none;}
.meta{font-size:.75em;color:#666;margin-top:2px;}
.controls{display:flex;gap:8px;padding-top:6px;}
.controls input,#privateControls input{padding:10px;border-radius:8px;border:1px solid #ccc;}
.controls button,#privateControls button{background:#4CAF50;color:#fff;border:none;cursor:pointer;padding:10px 12px;border-radius:8px;}
img{max-width:200px;border-radius:6px;margin-top:6px;}
audio{margin-top:6px;width:200px;}
/* CHAT PRIVADO FULLSCREEN */
#privateChatFull{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:#fff;
  z-index:200;
  display:none;
  flex-direction:column;
  padding:30px; /* padding interno para separar del borde */
  box-sizing:border-box;
}
#privateHeader{
  background:#4CAF50;
  color:#fff;
  padding:12px 15px;
  font-weight:bold;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-radius:6px;
  margin-bottom:15px; /* separaciÃ³n del Ã¡rea de mensajes */
}
#privateMessages{
  flex:1;
  overflow-y:auto;
  padding:15px; /* margen interno de mensajes */
  background:#f9f9f9;
  border-radius:8px;
  margin-bottom:15px; /* separaciÃ³n de los controles */
}
#privateControls{display:flex;gap:8px;padding-top:8px;}
</style>
</head>
<body>

<header>
  <strong>WilsChat</strong>
  <div id="chatMenuBtn">Chat â–¼</div>
</header>

<div id="chatMenuWindow"><div id="usersList"></div></div>

<div id="login">
  <h3>Ingresa tu nombre</h3>
  <input id="username" placeholder="Tu nombre">
  <button id="enterBtn">Entrar</button>
</div>

<div id="chat">
  <div id="messages"></div>
  <div class="controls">
    <input id="text" placeholder="Escribe un mensaje" style="flex:1">
    <input type="file" id="photoInput" accept="image/*" hidden>
    <button onclick="photoInput.click()">ðŸ“·</button>
    <button id="recordBtn">ðŸŽ¤</button>
    <button id="sendBtn">Enviar</button>
  </div>
</div>

<!-- CHAT PRIVADO FULLSCREEN -->
<div id="privateChatFull">
  <div id="privateHeader">
    <span id="privateUserName"></span>
    <button id="closePrivateBtn">âœ– Salir</button>
  </div>
  <div id="privateMessages"></div>
  <div id="privateControls">
    <input id="privateText" placeholder="Escribe un mensaje">
    <button id="privateSendBtn">Enviar</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
var firebaseConfig={
  apiKey:"AIzaSyAEkdn1nVDbrJEQY13JrE-peN1JkXrOy24",
  authDomain:"wilschat-1b27d.firebaseapp.com",
  databaseURL:"https://wilschat-1b27d-default-rtdb.firebaseio.com",
  projectId:"wilschat-1b27d",
  storageBucket:"wilschat-1b27d.appspot.com",
  messagingSenderId:"550632985900",
  appId:"1:550632985900:web:c886e89b4330560b6ac889"
};
firebase.initializeApp(firebaseConfig);

var db=firebase.database();
var storage=firebase.storage();
var user="", presenceKey=null, currentRef=null, privateWith=null;

function chatId(a,b){return [a,b].sort().join("_");}
function time(ts){return new Date(ts).toLocaleTimeString();}

function addMsg(m,container){
  var div=document.createElement("div");
  div.className="msg"+(m.user===user?" me":"");
  if(m.system){div.className+=" system"; div.textContent=m.text+" â€” "+time(m.ts); container.appendChild(div); return;}
  div.innerHTML="<strong>"+m.user+":</strong> ";
  if(m.type==="image"){var i=document.createElement("img"); i.src=m.url; div.appendChild(i);}
  else if(m.type==="audio"){var a=document.createElement("audio"); a.controls=true; a.src=m.url; div.appendChild(a);}
  else div.innerHTML+=" "+m.text;

  var meta=document.createElement("div"); meta.className="meta"; meta.textContent=time(m.ts);
  div.appendChild(meta);

  if(m.user!==user){div.style.cursor="pointer"; div.onclick=function(){ openPrivateFull(m.user); } }
  container.appendChild(div); container.scrollTop=container.scrollHeight;
}

/* LOGIN */
enterBtn.onclick=function(){
  if(!username.value.trim()) return;
  user=username.value.trim();
  login.style.display="none"; chat.style.display="flex";
  db.ref("users/"+user).set({name:user,lastSeen:Date.now()});
  var ref=db.ref("presence").push({name:user}); presenceKey=ref.key; ref.onDisconnect().remove();
  db.ref("mensajes").push({system:true,text:user+" entrÃ³ al chat",ts:Date.now()});
  listenPublic();
};

/* CHAT PUBLICO */
function listenPublic(){
  if(currentRef) currentRef.off();
  document.getElementById("messages").innerHTML="";
  currentRef=db.ref("mensajes").limitToLast(200);
  currentRef.on("child_added",s=>{if(s.val()) addMsg(s.val(),document.getElementById("messages"));});
}

/* ENVIAR */
sendBtn.onclick=function(){
  let textEl=document.getElementById("text");
  if(!textEl.value.trim()) return;
  db.ref("mensajes").push({user:user,text:textEl.value,ts:Date.now()});
  textEl.value="";
};

/* FOTOS */
photoInput.onchange=function(e){
  var f=e.target.files[0]; if(!f) return;
  var r=storage.ref("photos/"+Date.now()+f.name);
  r.put(f).then(s=>s.ref.getDownloadURL().then(u=>{ db.ref("mensajes").push({user:user,type:"image",url:u,ts:Date.now()}); }));
};

/* AUDIO */
let rec,chunks=[];
recordBtn.onclick=async function(){
  if(!rec||rec.state==="inactive"){
    var st=await navigator.mediaDevices.getUserMedia({audio:true});
    rec=new MediaRecorder(st); chunks=[];
    rec.ondataavailable=e=>chunks.push(e.data);
    rec.onstop=()=>{
      var b=new Blob(chunks,{type:"audio/webm"});
      var r=storage.ref("audios/"+Date.now()+".webm");
      r.put(b).then(s=>s.ref.getDownloadURL().then(u=>{ db.ref("mensajes").push({user:user,type:"audio",url:u,ts:Date.now()}); }));
    };
    rec.start(); this.textContent="â¹ï¸";
  }else{rec.stop(); this.textContent="ðŸŽ¤";}
};

/* MENÃš USUARIOS */
function updateUsers(){
  Promise.all([db.ref("users").once("value"),db.ref("presence").once("value")]).then(([u,p])=>{
    var online=[]; p.forEach(c=>online.push(c.val().name));
    var html="<strong>Conectados:</strong><br>";
    u.forEach(c=>{
      var n=c.key;
      if(online.includes(n)){ html+=`<span class="status online" onclick="openPrivateFull('${n}')">ðŸŸ¢ ${n}</span><br>`; }
    });
    html+="<strong>No conectados:</strong><br>";
    u.forEach(c=>{
      var n=c.key;
      if(!online.includes(n)){ html+=`<span class="status offline">âšª ${n}</span><br>`; }
    });
    document.getElementById("usersList").innerHTML=html;
  });
}
db.ref("presence").on("value",updateUsers);
db.ref("users").on("value",updateUsers);

/* CHAT PRIVADO FULLSCREEN */
function openPrivateFull(name){
  if(name===user) return;
  privateWith=name;
  document.getElementById("privateUserName").textContent=name;
  document.getElementById("privateChatFull").style.display="flex";
  document.getElementById("privateMessages").innerHTML="";
  db.ref("mensajes_privados/"+chatId(user,name)).limitToLast(200).on("child_added",s=>{
    if(s.val()) addMsg(s.val(),document.getElementById("privateMessages"));
  });
}

/* ENVIAR PRIVADO */
document.getElementById("privateSendBtn").onclick=function(){
  let txt=document.getElementById("privateText");
  if(!txt.value.trim()||!privateWith) return;
  db.ref("mensajes_privados/"+chatId(user,privateWith)).push({user:user,text:txt.value,ts:Date.now()});
  txt.value="";
}

/* SALIR CHAT PRIVADO */
document.getElementById("closePrivateBtn").onclick=function(){
  document.getElementById("privateChatFull").style.display="none";
  privateWith=null;
}

/* MENÃš DESPLEGABLE */
chatMenuBtn.onclick=function(){
  var w=document.getElementById("chatMenuWindow");
  w.style.display = w.style.display==="block"?"none":"block";
};

window.addEventListener("beforeunload",()=>{ if(user) db.ref("users/"+user+"/lastSeen").set(Date.now()); });
</script>
</body>
</html>
