<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WilsChat</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4CAF50">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
body { font-family: Arial; background:#f2f2f2; margin:0; padding:0; }
header { background:#4CAF50; color:white; text-align:center; padding:10px; font-size:24px; }
#login-container, #chat-container {
  display:flex; flex-direction:column; height:90vh; margin:10px;
  border:1px solid #ccc; background:white; border-radius:5px;
  justify-content:center; align-items:center;
}
#login-container input, #input-container input {
  padding:10px; font-size:16px; border-radius:20px; border:1px solid #ccc;
}
#login-container button, #input-container button {
  margin-left:10px; padding:10px 20px; border-radius:20px;
  border:none; background:#4CAF50; color:white; font-size:16px;
}
#messages {
  flex:1; padding:10px; overflow-y:auto;
  border-bottom:1px solid #ccc; width:95%;
  display:flex; flex-direction:column;
}
.message {
  padding:8px 12px; margin:5px 0; border-radius:10px; max-width:70%;
}
.usuario { background:#DCF8C6; align-self:flex-end; }
.otro { background:#EDEDED; align-self:flex-start; }
#input-container { display:flex; padding:10px; width:95%; }
small { font-size:11px; color:#555; }
</style>
</head>

<body>
<header>WilsChat</header>

<div id="login-container">
  <h2>Ingresa tu nombre</h2>
  <input type="text" id="nombreInput" placeholder="Tu nombre">
  <button id="loginBtn">Entrar</button>
</div>

<div id="chat-container" style="display:none;">
  <div id="messages"></div>
  <div id="input-container">
    <input type="text" id="mensajeInput" placeholder="Escribe un mensajeâ€¦">
    <button id="sendBtn">Enviar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// ðŸ”¹ ConfiguraciÃ³n real de Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAEkdn1nVDbrJEQY13JrE-peN1JkXrOy24",
  authDomain: "wilschat-1b27d.firebaseapp.com",
  databaseURL: "https://wilschat-1b27d-default-rtdb.firebaseio.com",
  projectId: "wilschat-1b27d",
  storageBucket: "wilschat-1b27d.firebasestorage.app",
  messagingSenderId: "550632985900",
  appId: "1:550632985900:web:c886e89b4330560b6ac889",
  measurementId: "G-QRMZQWF4KQ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ðŸ”¹ Esperar a que el DOM estÃ© cargado
document.addEventListener('DOMContentLoaded', () => {

  const loginContainer = document.getElementById('login-container');
  const chatContainer = document.getElementById('chat-container');
  const nombreInput = document.getElementById('nombreInput');
  const loginBtn = document.getElementById('loginBtn');
  const mensajeInput = document.getElementById('mensajeInput');
  const sendBtn = document.getElementById('sendBtn');
  const messagesContainer = document.getElementById('messages');

  let username = '';

  function mostrarMensaje(texto, usuario, clase, tiempo){
    const div = document.createElement('div');
    const hora = new Date(tiempo).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    div.className = 'message ' + clase;
    div.innerHTML = `<strong>${usuario}</strong><br>${texto}<br><small>${hora}</small>`;
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // ðŸ”¹ Evento del botÃ³n "Entrar"
  loginBtn.onclick = () => {
    if(nombreInput.value.trim() === '') return;
    username = nombreInput.value.trim();
    loginContainer.style.display = 'none';
    chatContainer.style.display = 'flex';

    // Mensaje de bienvenida
    push(ref(db,'mensajes'), {
      texto: `ðŸ‘‹ ${username} se uniÃ³ al chat`,
      usuario: 'WilsChat',
      timestamp: Date.now()
    });
  };

  // ðŸ”¹ Enviar mensajes
  sendBtn.onclick = () => {
    if(mensajeInput.value.trim() === '') return;
    const texto = mensajeInput.value;
    push(ref(db,'mensajes'), {
      texto,
      usuario: username,
      timestamp: Date.now()
    });
    mensajeInput.value = '';
  };

  // ðŸ”¹ Enviar con Enter
  mensajeInput.addEventListener('keypress', e => {
    if(e.key === 'Enter') sendBtn.click();
  });

  // ðŸ”¹ Escucha mensajes en tiempo real
  onValue(ref(db,'mensajes'), snapshot => {
    messagesContainer.innerHTML = '';
    snapshot.forEach(snap => {
      const d = snap.val();
      mostrarMensaje(
        d.texto,
        d.usuario,
        d.usuario === username ? 'usuario' : 'otro',
        d.timestamp
      );
    });
  });

});
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>

</body>
</html>